datasource db {
  provider = "postgresql"
  
}

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}


// ===============================    USER MANAGEMENT =======================================

model User {
  id       String  @id @default(cuid())
  email    String  @unique
  name     String
  password String?
  
  // ✅ Location Preferences (WHY: Auto-filter OLX to user's city)
  city     String?  // "Delhi", "Mumbai"
  country  String?   @default("India")
  location String?   // Added for signup form
  
  // ✅ Budget Preferences (WHY: Auto-apply price filters)
  defaultBudgetMin Int? @default(0)
  defaultBudgetMax Int? @default(10000)
  
  // ✅ Travel Preferences (WHY: Show relevant options first)
  preferredCategory   String? // "pg", "hotel", "flats"
  userRoomCategory    String? // Added for signup form
  preferredTransport  String? // "train", "flight", "bus", "cab"
  
  // ✅ Account Status (WHY: Security + Email verification)
  isVerified    Boolean  @default(false)
  emailVerified Boolean @default(false)
  
  // ✅ Timestamps (WHY: Track user activity)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  savedListings SavedListing[]
  sessions      Session[]
  accounts      Account[]
  @@index([email])
  @@index([city]) // Fast lookup by location
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  token     String
  createdAt DateTime
  updatedAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?
}

// ========== LISTINGS (Scraped OLX Data) ==========

model Listing {
  id     String @id @default(cuid())
  
  // ✅ OLX Reference (WHY: Prevent duplicate scraping, link to original)
  olxId  String @unique
  olxUrl String
  
  // ✅ Basic Info (WHY: Display to user)
  title       String
  description String? @db.Text
  category    String  // "pg", "rent-house", "cars", "bikes"
  
  // ✅ Pricing (WHY: Filtering + Sorting + Display)
  price    String // "₹ 5,000" - Display format
  priceRaw Int    // 5000 - For filtering/sorting
  currency String @default("INR")
  
  // ✅ Location (WHY: Filter by city + Show on map)
  location String // Full address
  city     String // "Delhi"
  state    String?
  
  // ✅ Property Details (WHY: Filter by rooms/size)
  bedrooms   Int?
  bathrooms  Int?
  furnishing String? // "Furnished", "Unfurnished"
  
  // ✅ Images (WHY: Show photos to user)
  images    String[]
  mainImage String?
  
  // ✅ Seller Info (WHY: Contact + Trust signals)
  sellerName     String
  sellerPhone    String?
  
  // ✅ Lifecycle Management (WHY: Hide old/expired listings)
  publishedAt DateTime
  scrapedAt   DateTime @default(now())
  isActive    Boolean  @default(true)
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  expiresAt   DateTime? // Auto-calculated: publishedAt + 30 days
  
  // ✅ Analytics (WHY: Track popular listings)
  viewCount Int @default(0)
  
  updatedAt DateTime @updatedAt
  
  // Relations
  savedBy SavedListing[]
  
  @@index([category, city, priceRaw, isActive]) // Fast search queries
  @@index([olxId]) // Prevent duplicate scraping
  @@index([expiresAt]) // Fast cleanup queries
}

// ========== SAVED LISTINGS (User Favorites) ==========

model SavedListing {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  // ✅ User Notes (WHY: "Near metro", "Contacted owner")
  notes String? @db.Text
  
  // ✅ Priority (WHY: Sort by importance)
  priority String @default("medium") // "high", "medium", "low"
  
  savedAt DateTime @default(now())
  
  @@unique([userId, listingId]) // Can't save same listing twice
  @@index([userId]) // Fast lookup of user's saved items
}

// ========== PRICE TRACKING (Price Drop Alerts) ==========

model PriceHistory {
  id       String @id @default(cuid())
  olxId    String // Reference to listing
  
  // ✅ Price Change (WHY: "Price dropped from ₹6000 to ₹5000")
  price    Int
  currency String @default("INR")
  
  recordedAt DateTime @default(now())
  
  @@index([olxId, recordedAt]) // Track price over time
}

// ========== OPTIONAL: ARCHIVE TABLE ==========
// (For data lifecycle management - discussed earlier)

model ArchivedListing {
  id         String @id @default(cuid())
  originalId String @unique
  
  // Copy essential fields from Listing
  title      String
  priceRaw   Int
  category   String
  city       String
  
  // ✅ Archive Metadata (WHY: Know why it was archived)
  archivedAt     DateTime @default(now())
  archivedReason String // "expired", "sold", "auto_cleanup"
  
  @@index([archivedAt])
}



// ========== TRAIN ROUTES (Scraped Train Data) ==========

model TrainRoute {
  id            String   @id @default(cuid())

  // Train Identification
  trainNumber   String   // "12301"
  trainName     String   // "Howrah Rajdhani Express"
  trainType     String   // "Rajdhani", "Shatabdi", "Express", "Superfast"

  // Route Details
  fromStation   String   // Station code: "NDLS"
  fromCity      String   // "New Delhi"
  toStation     String   // Station code: "HWH"
  toCity        String   // "Howrah"

  // Schedule
  departureTime String   // "16:55"
  arrivalTime   String   // "09:55"
  duration      String   // "17h 00m"
  distance      Int?     // in km
  runningDays   String[] // ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]

  // Pricing (cached, updated periodically)
  priceSleeper  Int?     // Sleeper class price
  priceAC3      Int?     // AC 3-tier price
  priceAC2      Int?     // AC 2-tier price
  priceAC1      Int?     // AC 1st class price
  priceGeneral  Int?     // General class price

  // Metadata
  source        String   @default("confirmtkt") // "confirmtkt", "redbus", "irctc"
  sourceUrl     String?
  scrapedAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isActive      Boolean  @default(true)

  @@unique([trainNumber, fromStation, toStation])
  @@index([fromCity, toCity])
  @@index([trainNumber])
  @@index([fromStation, toStation])
}

// ========== TRAIN SEARCH CACHE ==========

model TrainSearchCache {
  id           String   @id @default(cuid())
  fromCity     String
  toCity       String
  searchDate   DateTime?
  resultsCount Int      @default(0)

  // Cache Management
  lastSearched DateTime @default(now())
  isStale      Boolean  @default(false)

  @@unique([fromCity, toCity])
  @@index([fromCity, toCity])
}

// ========== FLIGHT ROUTES (Scraped Flight Data) ==========

model FlightRoute {
  id            String   @id @default(cuid())

  // Flight Identification
  flightNumber  String?  // "6E 2341"
  airline       String   // "IndiGo", "Air India", "SpiceJet"
  airlineCode   String?  // "6E", "AI", "SG"

  // Route Details
  fromAirport   String   // Airport code: "DEL"
  fromCity      String   // "New Delhi"
  toAirport     String   // Airport code: "BOM"
  toCity        String   // "Mumbai"

  // Schedule
  departureTime String   // "06:00"
  arrivalTime   String   // "08:15"
  duration      String   // "2h 15m"
  stops         Int      @default(0) // 0 = non-stop

  // Pricing
  priceEconomy  Int      // Economy class price
  priceBusiness Int?     // Business class price

  // Flight Date (for which date this price is valid)
  flightDate    DateTime

  // Metadata
  source        String   @default("ixigo") // "ixigo", "skyscanner", "makemytrip"
  sourceUrl     String?
  scrapedAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isActive      Boolean  @default(true)

  @@index([fromCity, toCity, flightDate])
  @@index([fromAirport, toAirport])
  @@index([airline])
}

// ========== FLIGHT SEARCH CACHE ==========

model FlightSearchCache {
  id           String   @id @default(cuid())
  fromCity     String
  toCity       String
  searchDate   DateTime
  resultsCount Int      @default(0)

  // Cache Management
  lastSearched DateTime @default(now())
  isStale      Boolean  @default(false)

  @@unique([fromCity, toCity, searchDate])
  @@index([fromCity, toCity])
}
